- name: Create namespaces, configmap, secret, RBAC
  hosts: localhost
  gather_facts: false
  vars:
    kubeconfig_path: "{{ lookup('env','WORKSPACE') | default('') }}/.kube/config"
  tasks:
    - name: Create namespaces (app, ops)
      shell: |
        kubectl create ns app --dry-run=client -o yaml | kubectl apply -f -
        kubectl create ns ops --dry-run=client -o yaml | kubectl apply -f -
      environment: { KUBECONFIG: "{{ kubeconfig_path }}" }

    - name: Create ConfigMap (demo)
      shell: |
        kubectl -n app create configmap app-config \
          --from-literal=LOG_LEVEL=info \
          --dry-run=client -o yaml | kubectl apply -f -
      environment: { KUBECONFIG: "{{ kubeconfig_path }}" }

    - name: Create Secret (demo - replace later with Jenkins credentials)
      shell: |
        kubectl -n app create secret generic app-secret \
          --from-literal=API_KEY=dummy123 \
          --dry-run=client -o yaml | kubectl apply -f -
      environment: { KUBECONFIG: "{{ kubeconfig_path }}" }

    - name: Create RBAC (read-only Role for app namespace)
      shell: |
        cat <<'YAML' | kubectl apply -f -
        apiVersion: v1
        kind: ServiceAccount
        metadata:
          name: app-sa
          namespace: app
        ---
        apiVersion: rbac.authorization.k8s.io/v1
        kind: Role
        metadata:
          name: app-read
          namespace: app
        rules:
        - apiGroups: [""]
          resources: ["pods","services","endpoints","configmaps"]
          verbs: ["get","list","watch"]
        ---
        apiVersion: rbac.authorization.k8s.io/v1
        kind: RoleBinding
        metadata:
          name: app-read-binding
          namespace: app
        subjects:
        - kind: ServiceAccount
          name: app-sa
          namespace: app
        roleRef:
          kind: Role
          name: app-read
          apiGroup: rbac.authorization.k8s.io
        YAML
      environment: { KUBECONFIG: "{{ kubeconfig_path }}" }

