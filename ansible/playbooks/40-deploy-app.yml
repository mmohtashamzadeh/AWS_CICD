- name: Deploy sample app (nginx)
  hosts: localhost
  gather_facts: false
  vars:
    kubeconfig_path: "{{ lookup('env','WORKSPACE') | default('') }}/.kube/config"
  tasks:
    - name: Deploy nginx + LoadBalancer Service
      shell: |
        cat <<'YAML' | kubectl apply -f -
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: web
          namespace: app
        spec:
          replicas: 2
          selector:
            matchLabels: { app: web }
          template:
            metadata:
              labels: { app: web }
            spec:
              serviceAccountName: app-sa
              containers:
              - name: nginx
                image: nginx:1.27
                ports:
                - containerPort: 80
        ---
        apiVersion: v1
        kind: Service
        metadata:
          name: web-svc
          namespace: app
        spec:
          selector: { app: web }
          ports:
          - port: 80
            targetPort: 80
          type: LoadBalancer
        YAML
      environment: { KUBECONFIG: "{{ kubeconfig_path }}" }

